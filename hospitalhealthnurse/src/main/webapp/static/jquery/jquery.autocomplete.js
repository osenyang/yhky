(function(A){A.fn.extend({autocomplete:function(B,C){var D=typeof B=="string";C=A.extend({},A.Autocompleter.defaults,{url:D?B:null,data:D?null:B,delay:D?A.Autocompleter.defaults.delay:10,max:C&&!C.scroll?10:150},C);C.highlight=C.highlight||function(E){return E};C.formatMatch=C.formatMatch||C.formatItem;return this.each(function(){new A.Autocompleter(this,C)})},result:function(B){return this.bind("result",B)},search:function(B){return this.trigger("search",[B])},flushCache:function(){return this.trigger("flushCache")},setOptions:function(B){return this.trigger("setOptions",[B])},unautocomplete:function(){return this.trigger("unautocomplete")}});A.Autocompleter=function(M,T){var N={UP:38,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8};var H=A(M).attr("autocomplete","off").addClass(T.inputClass);var O;var D="";var G=A.Autocompleter.Cache(T);var U=0;var Q;var V={mouseDownOnSelect:false};var P=A.Autocompleter.Select(T,M,S,V);var K;A.browser.opera&&A(M.form).bind("submit.autocomplete",function(){if(K){K=false;return false}});H.bind((A.browser.opera?"keypress":"keydown")+".autocomplete",function(Y){U=1;Q=Y.keyCode;switch(Y.keyCode){case N.UP:Y.preventDefault();if(P.visible()){P.prev()}else{C(0,true)}break;case N.DOWN:Y.preventDefault();if(P.visible()){P.next()}else{C(0,true)}break;case N.PAGEUP:Y.preventDefault();if(P.visible()){P.pageUp()}else{C(0,true)}break;case N.PAGEDOWN:Y.preventDefault();if(P.visible()){P.pageDown()}else{C(0,true)}break;case T.multiple&&A.trim(T.multipleSeparator)==","&&N.COMMA:case N.TAB:case N.RETURN:if(S()){Y.preventDefault();K=true;return false}break;case N.ESC:P.hide();break;default:clearTimeout(O);O=setTimeout(C,T.delay);break}}).focus(function(){U++}).blur(function(){U=0;if(!V.mouseDownOnSelect){L()}}).click(function(){if(U++>1&&!P.visible()){C(0,true)}}).bind("search",function(){var Z=(arguments.length>1)?arguments[1]:null;function Y(c,d){var b;if(d&&d.length){for(var a=0;a<d.length;a++){if(d[a].result.toLowerCase()==c.toLowerCase()){b=d[a];break}}}if(typeof Z=="function"){Z(b)}else{H.trigger("result",b&&[b.data,b.value])}}A.each(E(H.val()),function(a,b){I(b,Y,Y)})}).bind("flushCache",function(){G.flush()}).bind("setOptions",function(){A.extend(T,arguments[1]);if("data" in arguments[1]){G.populate()}}).bind("unautocomplete",function(){P.unbind();H.unbind();A(M.form).unbind(".autocomplete")});function S(){var e=P.selected();if(!e){return false}var c=e.result;D=c;if(T.multiple){var Y=E(H.val());if(Y.length>1){var d=T.multipleSeparator.length;var b=A(M).selection().start;var a,Z=0;A.each(Y,function(f,g){Z+=g.length;if(b<=Z){a=f;return false}Z+=d});Y[a]=c;c=Y.join(T.multipleSeparator)}c+=T.multipleSeparator}H.val(c);B();H.trigger("result",[e.data,e.value]);return true}function C(Y,Z){if(Q==N.DEL){P.hide();return}var a=H.val();if(!Z&&a==D){return}D=a;a=J(a);if(a.length>=T.minChars){H.addClass(T.loadingClass);if(!T.matchCase){a=a.toLowerCase()}I(a,W,B)}else{R();P.hide()}}function E(Y){if(!Y){return[""]}if(!T.multiple){return[A.trim(Y)]}return A.map(Y.split(T.multipleSeparator),function(Z){return A.trim(Y).length?A.trim(Z):null})}function J(a){if(!T.multiple){return a}var Y=E(a);if(Y.length==1){return Y[0]}var Z=A(M).selection().start;if(Z==a.length){Y=E(a)}else{Y=E(a.replace(a.substring(Z),""))}return Y[Y.length-1]}function X(Z,Y){if(T.autoFill&&(J(H.val()).toLowerCase()==Z.toLowerCase())&&Q!=N.BACKSPACE){H.val(H.val()+Y.substring(J(D).length));A(M).selection(D.length,D.length+Y.length)}}function L(){clearTimeout(O);O=setTimeout(B,200)}function B(){var Y=P.visible();P.hide();clearTimeout(O);R();if(T.mustMatch){H.search(function(a){if(!a){if(T.multiple){var Z=E(H.val()).slice(0,-1);H.val(Z.join(T.multipleSeparator)+(Z.length?T.multipleSeparator:""))}else{H.val("");H.trigger("result",null)}}})}}function W(Y,Z){if(Z&&Z.length&&U){R();P.display(Z,Y);X(Y,Z[0].value);P.show()}else{B()}}function I(b,Y,a){if(!T.matchCase){b=b.toLowerCase()}var c=G.load(b);if(c&&c.length){Y(b,c)}else{if((typeof T.url=="string")&&(T.url.length>0)){var Z={timestamp:+new Date()};A.each(T.extraParams,function(d,e){Z[d]=typeof e=="function"?e():e});A.ajax({type:"post",mode:"abort",port:"autocomplete"+M.name,dataType:T.dataType,url:T.url,data:A.extend({q:J(b),limit:T.max},Z),success:function(e){var d=T.parse&&T.parse(e)||F(e);G.add(b,d);Y(b,d)}})}else{P.emptyList();a(b)}}}function F(c){var b=[];var a=c.split("\n");for(var Y=0;Y<a.length;Y++){var Z=A.trim(a[Y]);if(Z){Z=Z.split("|");b[b.length]={data:Z,value:Z[0],result:T.formatResult&&T.formatResult(Z,Z[0])||Z[0]}}}return b}function R(){H.removeClass(T.loadingClass)}};A.Autocompleter.defaults={inputClass:"ac_input",resultsClass:"ac_results",loadingClass:"ac_loading",minChars:1,delay:400,matchCase:false,matchSubset:true,matchContains:false,cacheLength:10,max:100,mustMatch:false,extraParams:{},selectFirst:true,formatItem:function(B){return B[0]},formatMatch:null,autoFill:false,width:0,multiple:false,multipleSeparator:", ",highlight:function(C,B){return C.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+B.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180};A.Autocompleter.Cache=function(E){var H={};var B=0;function C(J,K){if(!E.matchCase){J=J.toLowerCase()}var I=J.indexOf(K);if(E.matchContains=="word"){I=J.toLowerCase().search("\\b"+K.toLowerCase())}if(I==-1){return false}return I==0||E.matchContains}function G(I,J){if(B>E.cacheLength){D()}if(!H[I]){B++}H[I]=J}function F(){if(!E.data){return false}var N={},K=0;if(!E.url){E.cacheLength=1}N[""]=[];for(var M=0,I=E.data.length;M<I;M++){var J=E.data[M];J=(typeof J=="string")?[J]:J;var L=E.formatMatch(J,M+1,E.data.length);if(L===false){continue}var O=L.charAt(0).toLowerCase();if(!N[O]){N[O]=[]}var P={value:L,data:J,result:E.formatResult&&E.formatResult(J)||L};N[O].push(P);if(K++<E.max){N[""].push(P)}}A.each(N,function(Q,R){E.cacheLength++;G(Q,R)})}setTimeout(F,25);function D(){H={};B=0}return{flush:D,add:G,populate:F,load:function(K){if(!E.cacheLength||!B){return null}if(!E.url&&E.matchContains){var M=[];for(var I in H){if(I.length>0){var L=H[I];A.each(L,function(N,O){if(C(O.value,K)){M.push(O)}})}}return M}else{if(H[K]){return H[K]}else{if(E.matchSubset){for(var J=K.length-1;J>=E.minChars;J--){var L=H[K.substr(0,J)];if(L){var M=[];A.each(L,function(N,O){if(C(O.value,K)){M[M.length]=O}});return M}}}}}return null}}};A.Autocompleter.Select=function(K,G,H,Q){var I={ACTIVE:"ac_over"};var M,D=-1,N,L="",C=true,J,B;function R(){if(!C){return}J=A("<div/>").hide().addClass(K.resultsClass).css("position","absolute").appendTo(document.body);B=A("<ul/>").appendTo(J).mouseover(function(T){if(O(T).nodeName&&O(T).nodeName.toUpperCase()=="LI"){D=A("li",B).removeClass(I.ACTIVE).index(O(T));A(O(T)).addClass(I.ACTIVE)}}).click(function(T){A(O(T)).addClass(I.ACTIVE);H();G.focus();return false}).mousedown(function(){Q.mouseDownOnSelect=true}).mouseup(function(){Q.mouseDownOnSelect=false});if(K.width>0){J.css("width",K.width)}C=false}function O(T){var U=T.target;while(U&&U.tagName!="LI"){U=U.parentNode}if(!U){return[]}return U}function P(T){M.slice(D,D+1).removeClass(I.ACTIVE);S(T);var V=M.slice(D,D+1).addClass(I.ACTIVE);if(K.scroll){var U=0;M.slice(0,D).each(function(){U+=this.offsetHeight});if((U+V[0].offsetHeight-B.scrollTop())>B[0].clientHeight){B.scrollTop(U+V[0].offsetHeight-B.innerHeight())}else{if(U<B.scrollTop()){B.scrollTop(U)}}}}function S(T){D+=T;if(D<0){D=M.size()-1}else{if(D>=M.size()){D=0}}}function F(T){return K.max&&K.max<T?K.max:T}function E(){B.empty();var W=F(N.length);for(var U=0;U<W;U++){if(!N[U]){continue}var T=K.formatItem(N[U].data,U+1,W,N[U].value,L);if(T===false){continue}var V=A("<li/>").html(K.highlight(T,L)).addClass(U%2==0?"ac_even":"ac_odd").appendTo(B)[0];A.data(V,"ac_data",N[U])}M=B.find("li");if(K.selectFirst){M.slice(0,1).addClass(I.ACTIVE);D=0}if(A.fn.bgiframe){B.bgiframe()}}return{display:function(T,U){R();N=T;L=U;E()},next:function(){P(1)},prev:function(){P(-1)},pageUp:function(){if(D!=0&&D-8<0){P(-D)}else{P(-8)}},pageDown:function(){if(D!=M.size()-1&&D+8>M.size()){P(M.size()-1-D)}else{P(8)}},hide:function(){J&&J.hide();M&&M.removeClass(I.ACTIVE);D=-1},visible:function(){return J&&J.is(":visible")},current:function(){return this.visible()&&(M.filter("."+I.ACTIVE)[0]||K.selectFirst&&M[0])},show:function(){var T=A(G).offset();J.css({width:typeof K.width=="string"||K.width>0?K.width:A(G).width(),top:T.top+G.offsetHeight,left:T.left}).show();if(K.scroll){B.scrollTop(0);B.css({maxHeight:K.scrollHeight,overflow:"auto"});if(A.browser.msie&&typeof document.body.style.maxHeight==="undefined"){var U=0;M.each(function(){U+=this.offsetHeight});var V=U>K.scrollHeight;B.css("height",V?K.scrollHeight:U);if(!V){M.width(B.width()-parseInt(M.css("padding-left"))-parseInt(M.css("padding-right")))}}}},selected:function(){var T=M&&M.filter("."+I.ACTIVE).removeClass(I.ACTIVE);return T&&T.length&&A.data(T[0],"ac_data")},emptyList:function(){B&&B.empty()},unbind:function(){J&&J.remove()}}};A.fn.selection=function(B,C){if(B!==undefined){return this.each(function(){if(this.createTextRange){var J=this.createTextRange();if(C===undefined||B==C){J.move("character",B);J.select()}else{J.collapse(true);J.moveStart("character",B);J.moveEnd("character",C);J.select()}}else{if(this.setSelectionRange){this.setSelectionRange(B,C)}else{if(this.selectionStart){this.selectionStart=B;this.selectionEnd=C}}}})}var E=this[0];if(E.createTextRange){var H=document.selection.createRange(),I=E.value,D="<->",G=H.text.length;H.text=D;var F=E.value.indexOf(D);E.value=I;this.selection(F,F+G);return{start:F,end:F+G}}else{if(E.selectionStart!==undefined){return{start:E.selectionStart,end:E.selectionEnd}}}}})(jQuery);